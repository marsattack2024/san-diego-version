<!-- 
  Marlin Chat Widget - Google Tag Manager Snippet
  This HTML snippet should be added as a Custom HTML tag in Google Tag Manager
  for programs.thehighrollersclub.io
-->
<script>
// Use an IIFE (Immediately Invoked Function Expression) for proper scoping
(function() {
  // Skip if already loaded or on unsupported browsers
  if (window.marlinChatWidgetLoaded || !window.localStorage) {
    return;
  }
  
  // Configure the widget (customize as needed)
  window.marlinChatConfig = {
    position: 'bottom-right',
    title: 'Ask Marlin',
    primaryColor: '#0070f3',
    // Updated to the correct API endpoint
    apiEndpoint: 'https://programs.thehighrollersclub.io/api/widget-chat'
  };
  
  // Dynamically load the widget resources
  var script = document.createElement('script');
  // Updated to point directly to the built file location
  script.src = 'https://programs.thehighrollersclub.io/widget/chat-widget.js';
  script.async = true;
  script.defer = true;
  script.onerror = function() {
    console.warn('Failed to load Marlin Chat Widget');
    console.error('Widget script failed to load from ' + script.src);
  };
  
  // Track GTM events for analytics
  script.onload = function() {
    // Push dataLayer event for successful widget load
    if (window.dataLayer) {
      window.dataLayer.push({
        'event': 'marlinChatWidgetLoaded',
        'marlinChatWidget': {
          'status': 'loaded'
        }
      });
    }
    
    // Add event listeners to track widget usage if initChatWidget exists
    if (window.initChatWidget) {
      // Custom event listener for widget interactions
      document.addEventListener('marlinChatWidgetEvent', function(e) {
        if (window.dataLayer && e.detail) {
          window.dataLayer.push({
            'event': 'marlinChatWidgetInteraction',
            'marlinChatWidget': e.detail
          });
        }
      });
      
      // Initialize the widget
      window.initChatWidget(window.marlinChatConfig);
    }
  };
  
  // Append the script to the document
  document.head.appendChild(script);
})();
</script> 